@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IJSRuntime JSRuntime
@using Microsoft.EntityFrameworkCore
@using MonitoreoMultifuente3.Models
@using Microsoft.AspNetCore.Components.Authorization

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">
            <img src="images/icons/Home.png" style="height:24px; margin-right:10px;" />
            MONITOREO APP
        </a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column h-100">

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <img src="images/icons/Home.png" class="nav-icon-img" /> Inicio
            </NavLink>
        </div>

        <AuthorizeView>
            <NotAuthorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="login">
                        <img src="images/icons/Login.png" class="nav-icon-img" /> Iniciar Sesión
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>

        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Escenarios">
                        <img src="images/icons/DatosDeMuestra.png" class="nav-icon-img" /> Escenarios
                    </NavLink>
                </div>

                <div class="nav-item px-3">
                    <div class="nav-link" @onclick="ToggleMonitoreoSubMenu" style="cursor: pointer;">
                        <img src="images/icons/Monitoreo.png" class="nav-icon-img" />
                        Monitoreo
                        <span class="oi @(collapseMonitoreoSubMenu ? "oi-caret-bottom" : "oi-caret-right")" style="float: right;"></span>
                    </div>

                    <div class="@(collapseMonitoreoSubMenu ? "collapse show" : "collapse")">
                        <nav class="flex-column">
                            <div class="nav-item px-3 ms-4">
                                <NavLink class="nav-link" href="monitoreo">
                                    <span class="bi bi-grid" aria-hidden="true"></span> General
                                </NavLink>
                            </div>
                            @foreach (var sensor in sensores)
                            {
                                <div class="nav-item px-3 ms-4">
                                    <NavLink class="nav-link" href="@($"monitoreo/{sensor.sensor_id}")">
                                        <span class="bi bi-dot" aria-hidden="true"></span> @sensor.nombre_sensor
                                    </NavLink>
                                </div>
                            }
                        </nav>
                    </div>
                </div>

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="estadisticas">
                        <img src="images/icons/Estadisticas.png" class="nav-icon-img" /> Estadísticas
                    </NavLink>
                </div>

                <div class="flex-grow-1"></div>
                <hr class="text-white mx-3 my-2 opacity-50" />

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="configuracion">
                        <img src="images/icons/Configuracion.png" class="nav-icon-img" /> Configuración
                    </NavLink>
                </div>

                <div class="nav-item px-3 my-2">
                    <div class="d-flex justify-content-around bg-dark bg-opacity-50 rounded p-2 border border-secondary align-items-center">

                        <button class="btn btn-sm p-1 border-0 @(currentTheme == "light" ? "bg-white bg-opacity-25 rounded shadow-sm" : "opacity-50")"
                                @onclick='() => CambiarTema("light")' title="Modo Claro">
                            <img src="images/modoclaro.svg" alt="Claro" style="width: 22px; height: 22px;" />
                        </button>

                        <button class="btn btn-sm p-1 border-0 @(currentTheme == "dark" ? "bg-white bg-opacity-25 rounded shadow-sm" : "opacity-50")"
                                @onclick='() => CambiarTema("dark")' title="Modo Oscuro">
                            <img src="images/modooscuro.svg" alt="Oscuro" style="width: 22px; height: 22px;" />
                        </button>

                        <button class="btn btn-sm p-1 border-0 @(currentTheme == "auto" ? "bg-white bg-opacity-25 rounded shadow-sm" : "opacity-50")"
                                @onclick='() => CambiarTema("auto")' title="Predeterminado del Sistema">
                            <img src="images/modopredeterminado.svg" alt="Auto" style="width: 22px; height: 22px;" />
                        </button>
                    </div>
                </div>
                <div class="nav-item px-3 pb-3">
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="" />
                        <button type="submit" class="nav-link btn btn-link text-danger w-100 text-start ps-0">
                            <img src="images/icons/Login.png" class="nav-icon-img" style="filter: hue-rotate(140deg);" /> Salir
                        </button>
                    </form>
                </div>

            </Authorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    private bool collapseMonitoreoSubMenu = true;
    private List<Sensor> sensores = new();
    private string currentTheme = "auto";

    protected override async Task OnInitializedAsync()
    {
        using (var dbContext = DbFactory.CreateDbContext())
        {
            sensores = await dbContext.Sensores.OrderBy(s => s.sensor_id).ToListAsync();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Recuperar tema guardado para iluminar el botón correcto
            currentTheme = await JSRuntime.InvokeAsync<string>("ThemeManager.getSavedTheme");
            StateHasChanged();
        }
    }

    private async Task CambiarTema(string theme)
    {
        currentTheme = theme;
        await JSRuntime.InvokeVoidAsync("ThemeManager.setTheme", theme);
    }

    private void ToggleMonitoreoSubMenu() => collapseMonitoreoSubMenu = !collapseMonitoreoSubMenu;
}

<style>
    .nav-scrollable {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 3.5rem);
    }

    .flex-grow-1 {
        flex-grow: 1;
    }

    .nav-icon-img {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        object-fit: contain;
    }

    .nav-link {
        display: flex;
        align-items: center;
    }
</style>