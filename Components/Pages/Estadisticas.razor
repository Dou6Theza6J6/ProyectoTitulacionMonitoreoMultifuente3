@page "/estadisticas"
@attribute [Authorize]

@using ChartJs.Blazor.Common
@using ChartJs.Blazor.LineChart
@using ChartJs.Blazor.Common.Axes
@using ChartJs.Blazor.Common.Enums
@using ChartJs.Blazor.Common.Axes.Ticks
@using Microsoft.EntityFrameworkCore
@using MonitoreoMultifuente3.Data
@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Enums
@using OfficeOpenXml
@using System.IO

@inject IDbContextFactory<ApplicationDbContext> DbFactory

<h3>Estadísticas de Calidad del Agua</h3>

<div class="row g-3 align-items-center mb-3">
    <div class="col-auto">
        <label for="fechaInicio" class="form-label">Fecha Inicio:</label>
        <InputDate id="fechaInicio" class="form-control" @bind-Value="fechaInicio" />
    </div>
    <div class="col-auto">
        <label for="fechaFin" class="form-label">Fecha Fin:</label>
        <InputDate id="fechaFin" class="form-control" @bind-Value="fechaFin" />
    </div>

    <div class="col-auto">
        <label for="filtroEscenario" class="form-label">Escenario:</label>
        <select id="filtroEscenario" class="form-select" @bind="selectedEscenarioId">
            <option value="0">-- Todos los Escenarios --</option>
            @foreach (var esc in listaEscenarios)
            {
                <option value="@esc.escenario_id">@esc.nombre</option>
            }
        </select>
    </div>

    <div class="col-auto align-self-end">
        <button class="btn btn-primary" @onclick="CargarDatosGrafica">Filtrar</button>
    </div>
    <div class="col-auto align-self-end">
        <button class="btn btn-outline-secondary btn-sm" @onclick='() => AplicarFiltroTiempo("dia")'>Hoy</button>
        <button class="btn btn-outline-secondary btn-sm" @onclick='() => AplicarFiltroTiempo("semana")'>Semana</button>
        <button class="btn btn-outline-secondary btn-sm" @onclick='() => AplicarFiltroTiempo("mes")'>Mes</button>
    </div>
</div>

<div class="mb-3">
    <button class="btn btn-success" @onclick="ExportarAExcel">
        <span class="oi oi-document"></span> Exportar a Excel
    </button>
</div>

<hr />

<div style="width: 90%;">
    <Chart Config="_lineChartConfig" @ref="_lineChart"></Chart>
</div>

@code {
    private Chart? _lineChart;
    private DateTime? fechaInicio = DateTime.Today.AddDays(-7);
    private DateTime? fechaFin = DateTime.Today.AddDays(1).AddTicks(-1);

    // Variables para el filtro de escenario
    private List<Escenario> listaEscenarios = new();
    private int selectedEscenarioId = 0;

    private LineConfig _lineChartConfig = new LineConfig
    {
        Options = new LineOptions
        {
            Responsive = true,
            Title = new OptionsTitle { Display = true, Text = "Historial de Mediciones" },
            Scales = new Scales
            {
                XAxes = new List<CartesianAxis>
                {
                    new CategoryAxis
                    {
                        ScaleLabel = new ScaleLabel { Display = true, LabelString = "Tiempo" }
                    }
                },
                YAxes = new List<CartesianAxis>()
            }
        }
    };

    public class LinearAxisConId : LinearCartesianAxis
    {
        public string Id { get; set; } = "";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Cargar lista de escenarios al iniciar
            using (var dbContext = DbFactory.CreateDbContext())
            {
                listaEscenarios = await dbContext.Escenarios.OrderBy(e => e.nombre).ToListAsync();
            }
            StateHasChanged();

            await CargarDatosGrafica();
        }
    }

    private async Task CargarDatosGrafica()
    {
        List<Medicion> medicionesGrafica;
        using (var dbContext = DbFactory.CreateDbContext())
        {
            var query = dbContext.Mediciones
                                 .Include(m => m.Parametro)
                                 .Include(m => m.Sensor)
                                 .AsQueryable();

            // Filtros de Fecha
            if (fechaInicio.HasValue)
                query = query.Where(m => m.created_at >= fechaInicio.Value);
            if (fechaFin.HasValue)
                query = query.Where(m => m.created_at <= fechaFin.Value);

            // NUEVO: Filtro por Escenario
            if (selectedEscenarioId > 0)
            {
                query = query.Where(m => m.escenario_id == selectedEscenarioId);
            }

            medicionesGrafica = await query.OrderBy(m => m.created_at).ToListAsync();
        }

        // Limpiar y rellenar la gráfica
        _lineChartConfig.Data.Labels.Clear();
        _lineChartConfig.Data.Datasets.Clear();
        _lineChartConfig.Options.Scales.YAxes.Clear();

        var todasLasEtiquetas = medicionesGrafica
            .Select(m => m.created_at.ToLocalTime().ToString("g"))
            .Distinct()
            .ToList();

        foreach (var etiqueta in todasLasEtiquetas)
        {
            _lineChartConfig.Data.Labels.Add(etiqueta);
        }

        var grupos = medicionesGrafica
            .Where(m => m.Parametro != null)
            .GroupBy(m => m.Parametro);

        int axisIndex = 0;
        foreach (var grupo in grupos)
        {
            var parametro = grupo.Key;
            if (parametro == null) continue;

            string yAxisId = $"y-axis-{parametro.parametro_id}";
            var yAxis = new LinearAxisConId
            {
                Id = yAxisId,
                Display = AxisDisplay.True,
                Position = (axisIndex % 2 == 0) ? Position.Left : Position.Right,
                ScaleLabel = new ScaleLabel { Display = true, LabelString = parametro.unidad_medida },
                // CAMBIO REALIZADO AQUÍ: BeginAtZero = false para que la gráfica no se vea plana
                Ticks = new LinearCartesianTicks { BeginAtZero = false }
            };
            _lineChartConfig.Options.Scales.YAxes.Add(yAxis);

            var dataPoints = new List<double?>();
            foreach (var etiqueta in todasLasEtiquetas)
            {
                var medicion = grupo.FirstOrDefault(m => m.created_at.ToLocalTime().ToString("g") == etiqueta);
                if (medicion != null)
                {
                    double? valor = (medicion.Sensor?.tipo == 1)
                        ? (double?)medicion.valor_cv_decimal
                        : medicion.valor_analogico;
                    dataPoints.Add(valor);
                }
                else
                {
                    dataPoints.Add(null);
                }
            }

            var lineDataSet = new LineDataset<double?>(dataPoints)
            {
                Label = parametro.nombre_parametro,
                BorderColor = ObtenerColorAleatorio(),
                Fill = false,
                LineTension = 0.1f,
                YAxisId = yAxisId
            };
            _lineChartConfig.Data.Datasets.Add(lineDataSet);
            axisIndex++;
        }

        if (_lineChart != null) await _lineChart.Update();
        StateHasChanged();
    }

    private void AplicarFiltroTiempo(string rango)
    {
        var hoy = DateTime.Today;
        switch (rango)
        {
            case "dia": fechaInicio = hoy; fechaFin = hoy.AddDays(1).AddTicks(-1); break;
            case "semana": fechaInicio = hoy.AddDays(-(int)hoy.DayOfWeek); fechaFin = fechaInicio.Value.AddDays(7).AddTicks(-1); break;
            case "mes": fechaInicio = new DateTime(hoy.Year, hoy.Month, 1); fechaFin = fechaInicio.Value.AddMonths(1).AddTicks(-1); break;
        }
        _ = CargarDatosGrafica();
    }

    private async Task ExportarAExcel()
    {
        List<Medicion> medicionesParaExportar;
        using (var dbContext = DbFactory.CreateDbContext())
        {
            var query = dbContext.Mediciones
                                 .Include(m => m.Sensor)
                                 .Include(m => m.Parametro)
                                 .Include(m => m.Escenario) // Incluir escenario para el reporte
                                 .AsQueryable();

            if (fechaInicio.HasValue) query = query.Where(m => m.created_at >= fechaInicio.Value);
            if (fechaFin.HasValue) query = query.Where(m => m.created_at <= fechaFin.Value);

            // Filtro de Escenario en Exportación
            if (selectedEscenarioId > 0)
            {
                query = query.Where(m => m.escenario_id == selectedEscenarioId);
            }

            medicionesParaExportar = await query.OrderBy(m => m.created_at).ToListAsync();
        }

        if (!medicionesParaExportar.Any())
        {
            System.Windows.MessageBox.Show("No hay datos filtrados para exportar.", "Advertencia");
            return;
        }

        string carpetaDocumentos = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
        string nombreArchivo = $"Reporte_CalidadAgua_{DateTime.Now:yyyyMMddHHmmss}.xlsx";
        string rutaCompleta = Path.Combine(carpetaDocumentos, nombreArchivo);

        using (var package = new ExcelPackage(new FileInfo(rutaCompleta)))
        {
            var ws = package.Workbook.Worksheets.Add("Mediciones");
            ws.Cells[1, 1].Value = "Fecha";
            ws.Cells[1, 2].Value = "Escenario";
            ws.Cells[1, 3].Value = "Sensor";
            ws.Cells[1, 4].Value = "Parámetro";
            ws.Cells[1, 5].Value = "Valor";
            ws.Cells[1, 6].Value = "Calidad";

            for (int i = 0; i < medicionesParaExportar.Count; i++)
            {
                var m = medicionesParaExportar[i];
                int f = i + 2;
                ws.Cells[f, 1].Value = m.created_at.ToLocalTime().ToString("g");
                ws.Cells[f, 2].Value = m.Escenario?.nombre ?? "N/A";
                ws.Cells[f, 3].Value = m.Sensor?.nombre_sensor;
                ws.Cells[f, 4].Value = m.Parametro?.nombre_parametro;

                decimal? val = (m.Sensor?.tipo == 1) ? m.valor_cv_decimal : (decimal?)m.valor_analogico;
                ws.Cells[f, 5].Value = val;
                ws.Cells[f, 6].Value = ((StatusMedicion)m.status).ToString();
            }
            ws.Cells[ws.Dimension.Address].AutoFitColumns();
            await package.SaveAsync();
        }
        System.Windows.MessageBox.Show($"Guardado en: {rutaCompleta}", "Éxito");
    }

    private string ObtenerColorAleatorio()
    {
        var r = new Random();
        return $"rgba({r.Next(0, 200)}, {r.Next(0, 200)}, {r.Next(0, 200)}, 1)";
    }
}