@page "/Escenarios"
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Data
@inject ApplicationDbContext DbContext
@inject IJSRuntime JSRuntime

<PageTitle>Gestión de Escenarios</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>📍 Gestión de Escenarios</h3>
    </div>

    <div class="row">
        @* Columna Izquierda: Formulario *@
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Registrar Nuevo</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@nuevoEscenario" OnValidSubmit="GuardarMuestra">
                        <DataAnnotationsValidator />

                        <div class="mb-2">
                            <label class="form-label fw-bold small">Nombre</label>
                            <InputText class="form-control" @bind-Value="nuevoEscenario.nombre" placeholder="Ej: Pozo 3" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label fw-bold small">Tipo de Escenario</label>
                            <InputSelect class="form-select" @bind-Value="nuevoEscenario.tipo_e">
                                <option value="1">In Situ (Campo)</option>
                                <option value="2">Ex Situ (Laboratorio)</option>
                            </InputSelect>
                        </div>

                        <div class="mb-2">
                            <label class="form-label fw-bold small">Descripción</label>
                            <InputText class="form-control" @bind-Value="nuevoEscenario.descripcion" />
                        </div>

                        @* --- SECCIÓN CORREGIDA CON TUS NOMBRES DE PROPIEDAD --- *@
                        <div class="mb-2">
                            <label class="form-label fw-bold small">Dirección (Auto-relleno desde Mapa)</label>

                            <InputText class="form-control form-control-sm mb-1" @bind-Value="nuevoEscenario.calles" placeholder="Calle y número" />

                            <div class="row g-1">
                                <div class="col-4">
                                    <InputText class="form-control form-control-sm" @bind-Value="nuevoEscenario.codigo_p" placeholder="C.P." />
                                </div>
                                <div class="col-4">
                                    <InputText class="form-control form-control-sm" @bind-Value="nuevoEscenario.ciudad" placeholder="Ciudad" />
                                </div>
                                <div class="col-4">
                                    <InputText class="form-control form-control-sm" @bind-Value="nuevoEscenario.pais" placeholder="País" />
                                </div>
                            </div>
                        </div>
                        @* ---------------------------------------------------- *@

                        <div class="mb-2">
                            <label class="form-label fw-bold small">Nombre Ubicación (Alias)</label>
                            <InputText class="form-control" @bind-Value="nuevaUbicacion.nombre" placeholder="Ej: Entrada Principal" />
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold small">Coordenadas</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Lat</span>
                                <InputNumber class="form-control" @bind-Value="nuevaUbicacion.latitud" ReadOnly="true" />
                                <span class="input-group-text">Lon</span>
                                <InputNumber class="form-control" @bind-Value="nuevaUbicacion.longitud" ReadOnly="true" />
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100">💾 Guardar</button>
                    </EditForm>
                </div>
            </div>
        </div>

        @* Columna Derecha: Mapa *@
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-body p-0">
                    <div id="map" style="height: 100%; min-height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4" />

    @* Tabla Historial *@
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">📚 Historial</h5>
            <div class="d-flex align-items-center">
                <span class="text-white me-2 small">Filtrar:</span>
                <select class="form-select form-select-sm" style="width: 150px;" @bind="filtroTipo">
                    <option value="0">Todos</option>
                    <option value="1">In Situ</option>
                    <option value="2">Ex Situ</option>
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Descripción</th>
                        <th>Dirección</th>
                        <th>Fecha</th>
                        <AuthorizeView Roles="Administrador"><th class="text-center">Acciones</th></AuthorizeView>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in escenarios.Where(e => filtroTipo == 0 || e.tipo_e == filtroTipo))
                    {
                        <tr>
                            <td class="fw-bold text-primary">@item.nombre</td>
                            <td>
                                @if (item.tipo_e == 1)
                                {
                                    <span class="badge bg-success">In Situ</span>
                                }
                                else if (item.tipo_e == 2)
                                {

                                    <span class="badge bg-warning text-dark">Ex Situ</span>
                                }
                                else
                                {

                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>@item.descripcion</td>
                            <td>
                                @* Aquí mostramos los datos corregidos *@
                                <strong>@item.ciudad</strong>, @item.pais<br />
                                <small class="text-muted">@item.calles C.P: @item.codigo_p</small>
                            </td>
                            <td>@item.created_at.ToLocalTime().ToString("d")</td>
                            <AuthorizeView Roles="Administrador">
                                <Authorized>
                                    <td class="text-center">
                                        <button class="btn btn-danger btn-sm" @onclick="() => Eliminar(item)">🗑</button>
                                    </td>
                                </Authorized>
                            </AuthorizeView>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<Escenario> escenarios = new();
    private Escenario nuevoEscenario = new() { tipo_e = 1 };
    private Ubicacion nuevaUbicacion = new();
    private DotNetObjectReference<Escenarios>? dotNetHelper;
    private int filtroTipo = 0;

    protected override async Task OnInitializedAsync() => await Cargar();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("initMap", dotNetHelper);
        }
    }

    private async Task Cargar()
    {
        escenarios = await DbContext.Escenarios
            .Include(e => e.Ubicacion)
            .Where(e => e.nombre != "All")
            .OrderByDescending(x => x.created_at)
            .ToListAsync();
    }

    [JSInvokable]
    public async Task SetMapCoordinates(double lat, double lng, string calle = "", string cp = "", string ciudad = "", string pais = "")
    {
        nuevaUbicacion.latitud = Math.Round(lat, 6);
        nuevaUbicacion.longitud = Math.Round(lng, 6);

        // CORREGIDO: Asignación a propiedades correctas 'calles' y 'codigo_p'
        nuevoEscenario.calles = calle;
        nuevoEscenario.codigo_p = cp;
        nuevoEscenario.ciudad = ciudad;
        nuevoEscenario.pais = pais;

        if (string.IsNullOrWhiteSpace(nuevaUbicacion.nombre) && !string.IsNullOrWhiteSpace(calle))
        {
            nuevaUbicacion.nombre = calle;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task GuardarMuestra()
    {
        var now = DateTime.UtcNow;

        nuevaUbicacion.created_at = now;
        nuevaUbicacion.updated_at = now;
        DbContext.Ubicaciones.Add(nuevaUbicacion);
        await DbContext.SaveChangesAsync();

        nuevoEscenario.ubicacion_id = nuevaUbicacion.ubicacion_id;
        nuevoEscenario.created_at = now;
        nuevoEscenario.updated_at = now;
        DbContext.Escenarios.Add(nuevoEscenario);
        await DbContext.SaveChangesAsync();

        await Cargar();

        nuevoEscenario = new() { tipo_e = 1 };
        nuevaUbicacion = new();
    }

    private async Task Eliminar(Escenario e)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Eliminar?"))
        {
            try
            {
                DbContext.Escenarios.Remove(e);
                if (e.Ubicacion != null) DbContext.Ubicaciones.Remove(e.Ubicacion);
                await DbContext.SaveChangesAsync();
                await Cargar();
            }
            catch { await JSRuntime.InvokeVoidAsync("alert", "Error al eliminar."); }
        }
    }

    public async ValueTask DisposeAsync() { if (dotNetHelper != null) dotNetHelper.Dispose(); }
}