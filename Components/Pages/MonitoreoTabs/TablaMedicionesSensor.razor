@* MonitoreoMultifuente3/Components/Pages/MonitoreoTabs/TablaMedicionesSensor.razor *@

@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Enums
@using MonitoreoMultifuente3.Data
@using Microsoft.EntityFrameworkCore

@* CAMBIO: Ya no inyectamos el DbContext, sino la FÁBRICA *@
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Valor</th>
                <th>CV (%)</th>
                <th>Status</th>
                <th>Fecha/Hora</th>
            </tr>
        </thead>
        <tbody>
            @if (mediciones == null)
            {
                <tr>
                    <td colspan="5">Cargando mediciones...</td>
                </tr>
            }
            else
            {
                @foreach (var medicion in mediciones)
                {
                    <tr>
                        <td>@medicion.registro_medicion_id</td>
                        <td>@medicion.valor_analogico.ToString("F2")</td>

                        <td>@(medicion.valor_cv_decimal.HasValue ? medicion.valor_cv_decimal.Value.ToString("F2") : "---")</td>

                        <td>@((StatusMedicion)medicion.status_enum)</td>
                        <td>@medicion.fecha_hora.ToString("g")</td> 
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter]
    public int SensorId { get; set; }

    [Parameter]
    public int ParametroId { get; set; }

    private List<Medicion>? mediciones;

    // CAMBIO: Usamos la fábrica para crear un DbContext de corta duración
    protected override async Task OnParametersSetAsync()
    {
        // Creamos un contexto SÓLO para esta operación.
        using (var dbContext = DbFactory.CreateDbContext())
        {
            if (SensorId > 0 && ParametroId > 0)
            {
                mediciones = await dbContext.Mediciones
                    .Where(m => m.sensor_id == SensorId && m.parametro_id == ParametroId)
                    .OrderByDescending(m => m.fecha_hora) 
                    .Take(20)
                    .ToListAsync();
            }
        }
    }
}