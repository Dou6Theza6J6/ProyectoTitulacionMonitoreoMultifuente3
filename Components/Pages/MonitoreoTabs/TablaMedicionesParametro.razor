@* Este es un NUEVO componente que filtra por Parámetro en lugar de Sensor *@

@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Enums
@using MonitoreoMultifuente3.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext dbContext

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Sensor</th> @* ¡Ahora mostramos el Sensor! *@
                <th>Valor</th>
                <th>CV (%)</th>
                <th>Status</th>
                <th>Fecha/Hora</th>
            </tr>
        </thead>
        <tbody>
            @if (mediciones == null)
            {
                <tr>
                    <td colspan="6">Cargando mediciones...</td>
                </tr>
            }
            else
            {
                @foreach (var medicion in mediciones)
                {
                    <tr>
                        <td>@medicion.registro_medicion_id</td>

                        @* Mostramos el nombre del sensor que tomó esta lectura *@
                        <td>@medicion.Sensor.nombre_sensor</td>

                          <td>@medicion.valor_analogico.ToString("F2")</td>

                        @* Manejo de nulos que implementamos antes *@
                        <td>@(medicion.valor_cv_decimal.HasValue ? medicion.valor_cv_decimal.Value.ToString("F2") : "---")</td>

                        <td>@((StatusMedicion)medicion.status)</td>
                      <td>@medicion.fecha_hora.ToString("g")</td> 
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter]
    public int ParametroId { get; set; } // <-- El parámetro ahora es el ID del Parámetro

    private List<Medicion>? mediciones;

    protected override async Task OnParametersSetAsync()
    {
        // El 'Include' es vital para que .Sensor no sea nulo
        mediciones = await dbContext.Mediciones
            .Include(m => m.Sensor)      // Cargar datos del Sensor
            .Where(m => m.parametro_id == ParametroId) // <-- ¡FILTRADO POR PARÁMETRO!
            .OrderByDescending(m => m.fecha_hora)
            .Take(20)
            .ToListAsync();
    }
}