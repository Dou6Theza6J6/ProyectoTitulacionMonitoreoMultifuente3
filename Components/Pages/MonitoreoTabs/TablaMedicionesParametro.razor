@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Enums
@using MonitoreoMultifuente3.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<div class="card shadow mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Historial - @ParametroNombre</h6>

        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm @(filtro == "hoy" ? "btn-primary" : "btn-outline-primary")" @onclick='() => CargarDatos("hoy")'>Hoy</button>
            <button type="button" class="btn btn-sm @(filtro == "ayer" ? "btn-primary" : "btn-outline-primary")" @onclick='() => CargarDatos("ayer")'>Ayer</button>
            <button type="button" class="btn btn-sm @(filtro == "semana" ? "btn-primary" : "btn-outline-primary")" @onclick='() => CargarDatos("semana")'>Semana</button>
            <button type="button" class="btn btn-sm @(filtro == "mes" ? "btn-primary" : "btn-outline-primary")" @onclick='() => CargarDatos("mes")'>Mes</button>
            <button type="button" class="btn btn-sm @(filtro == "anio" ? "btn-primary" : "btn-outline-primary")" @onclick='() => CargarDatos("anio")'>Año</button>
        </div>
    </div>

    <div class="card-body">
        @if (mediciones == null)
        {
            <div class="text-center"><div class="spinner-border text-primary"></div></div>
        }
        else if (mediciones.Count == 0)
        {
            <p class="text-center text-muted">No hay datos registrados para este periodo.</p>
        }
        else
        {
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-bordered table-striped table-hover text-center">
                    <thead class="table-dark" style="position: sticky; top: 0;">
                        <tr>
                            <th>ID</th>
                            <th>Sensor</th>
                            <th>Valor (@Unidad)</th>
                            <th>CV (%)</th>
                            <th>Estado</th>
                            <th>Fecha/Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in mediciones)
                        {
                            <tr>
                                <td>@item.registro_medicion_id</td>
                                <td>@(item.Sensor != null ? item.Sensor.nombre_sensor : "Sensor eliminado")</td>

                                @* Datos reales de Medicion.cs *@
                                <td class="fw-bold">@item.valor_analogico.ToString("F2")</td>
                                <td>@(item.valor_cv_decimal.HasValue? item.valor_cv_decimal.Value.ToString("F2") : "0.00")</td>

                                <td>
                                    <span class="badge @ObtenerClaseStatus((StatusMedicion)item.status)">
                                        @((StatusMedicion)item.status)
                                    </span>
                                </td>

                                <td>@item.fecha_hora.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int ParametroId { get; set; }
    [Parameter] public string ParametroNombre { get; set; } = "Parámetro";
    [Parameter] public string Unidad { get; set; } = "";

    private List<Medicion>? mediciones;
    private string filtro = "hoy";

    protected override async Task OnParametersSetAsync()
    {
        await CargarDatos(filtro);
    }

    private async Task CargarDatos(string nuevoFiltro)
    {
        filtro = nuevoFiltro;
        using var context = DbFactory.CreateDbContext();

        // 1. Consulta base por Parámetro
        var query = context.Mediciones
            .Include(m => m.Sensor)
            .Where(m => m.parametro_id == ParametroId);

        // 2. Aplicar Filtros de Fecha
        DateTime hoy = DateTime.Today;

        switch (filtro)
        {
            case "hoy":
                query = query.Where(m => m.fecha_hora >= hoy);
                break;
            case "ayer":
                query = query.Where(m => m.fecha_hora >= hoy.AddDays(-1) && m.fecha_hora < hoy);
                break;
            case "semana":
                query = query.Where(m => m.fecha_hora >= hoy.AddDays(-7));
                break;
            case "mes":
                query = query.Where(m => m.fecha_hora >= hoy.AddMonths(-1));
                break;
            case "anio":
                query = query.Where(m => m.fecha_hora >= hoy.AddYears(-1));
                break;
        }

        // 3. Ordenar y Ejecutar
        mediciones = await query
            .OrderByDescending(m => m.fecha_hora)
            .Take(200) // Límite de seguridad
            .ToListAsync();

        StateHasChanged();
    }

    private string ObtenerClaseStatus(StatusMedicion status) => status switch
    {
        StatusMedicion.Ideal => "bg-success",
        StatusMedicion.Apta => "bg-primary",
        StatusMedicion.NoApta => "bg-danger",
        _ => "bg-secondary"
    };
}