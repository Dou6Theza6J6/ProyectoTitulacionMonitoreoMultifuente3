@page "/monitoreo"
@using MonitoreoMultifuente3.Enums
@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Data
@using MonitoreoMultifuente3.DTOs
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MonitoreoMultifuente3.Services

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject SensorDataService SensorService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@implements IDisposable

<PageTitle>Monitoreo</PageTitle>

<div class="container-fluid">
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">📡 Configuración</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">1. Escenario:</label>
                    <select class="form-select" @onchange="OnEscenarioChanged">
                        <option value="0">-- Ver Todo el Historial --</option>
                        @foreach (var esc in escenariosDisponibles)
                        {
                            <option value="@esc.escenario_id">@esc.nombre (@(esc.tipo_e == 1 ? "In Situ" : "Ex Situ"))</option>
                        }
                    </select>
                    @if (selectedEscenarioId > 0)
                    {
                        <small class="text-success">✔ Guardando en: @nombreEscenarioActual</small>
                    }
                    else
                    {

                        <small class="text-muted">👁 Modo Visualización Global</small>
                    }
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">2. Sensor:</label>
                    <select class="form-select" @onchange="OnSensorChanged">
                        <option value="0">-- Seleccione --</option>
                        @foreach (var s in sensoresDisponibles)
                        {
                            <option value="@s.sensor_id">@s.nombre_sensor</option>
                        }
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">3. Puerto:</label>
                    <div class="input-group">
                        <select @bind="selectedPort" class="form-select" disabled="@isListening">
                            @foreach (var p in availablePorts)
                            {
                                <option value="@p">@p</option>
                            }
                        </select>
                        <button class="btn btn-primary" @onclick="StartListening"
                                disabled="@(string.IsNullOrEmpty(selectedPort) || selectedEscenarioId == 0 || selectedSensorId == 0)">
                            ▶
                        </button>
                        @if (isListening)
                        {
                            <button class="btn btn-danger" @onclick="StopListening">⏹</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-secondary text-white">Historial</div>
        <div class="card-body table-responsive" style="height:500px">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        @if (selectedEscenarioId == 0)
                        {
                            <th>Escenario</th>
                        }
                        <th>Parámetro</th>
                        <th>Valor</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in historialMediciones)
                    {
                        <tr>
                            <td>@m.fecha_hora.ToLocalTime()</td>
                            @if (selectedEscenarioId == 0)
                            {
                                <td><small>@m.Escenario?.nombre</small></td>
                            }
                            <td class="fw-bold text-primary">@m.Parametro?.nombre_parametro</td>
                            <td>@m.valor_analogico.ToString("F2")</td>
                            <td>@((StatusMedicion)m.status)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    // ... Tus variables ...
    private List<Escenario> escenariosDisponibles = new();
    private List<Sensor> sensoresDisponibles = new();
    private List<Medicion> historialMediciones = new();
    private string[] availablePorts = Array.Empty<string>();

    private int selectedEscenarioId = 0;
    private string nombreEscenarioActual = "";
    private int selectedSensorId = 0;
    private string selectedPort = "";
    private bool isListening = false;

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        escenariosDisponibles = await db.Escenarios.Include(e => e.Ubicacion).ToListAsync();
        sensoresDisponibles = await db.Sensores.ToListAsync();

        // Usuario actual
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user != null) SensorService.SetCurrentUser(user.Id);

        availablePorts = SensorService.GetAvailablePorts();
        if (availablePorts.Any()) selectedPort = availablePorts[0];

        SensorService.OnDataReceived += (d) => InvokeAsync(CargarHistorial);
        await CargarHistorial();
    }

    private async Task OnEscenarioChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedEscenarioId = id;
            var esc = escenariosDisponibles.FirstOrDefault(x => x.escenario_id == id);
            nombreEscenarioActual = esc?.nombre ?? "";
            SensorService.SetCurrentEscenario(id);
            await CargarHistorial();
        }
    }

    private void OnSensorChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedSensorId = id;
            SensorService.SetCurrentSensor(id);
            _ = CargarHistorial();
        }
    }

    private async Task CargarHistorial()
    {
        using var db = DbFactory.CreateDbContext();
        var q = db.Mediciones
            .Include(m => m.Parametro)
            .Include(m => m.Escenario)
            .AsQueryable();

        // SI ES 0, TRAE TODO. SI NO, FILTRA.
        if (selectedEscenarioId > 0) q = q.Where(m => m.escenario_id == selectedEscenarioId);
        if (selectedSensorId > 0) q = q.Where(m => m.sensor_id == selectedSensorId);

        historialMediciones = await q.OrderByDescending(m => m.fecha_hora).Take(100).ToListAsync();
        await InvokeAsync(StateHasChanged);
    }

    private void StartListening()
    {
        if (selectedEscenarioId > 0 && selectedSensorId > 0)
        {
            if (SensorService.StartListening(selectedPort)) isListening = true;
        }
    }

    private void StopListening()
    {
        SensorService.StopListening();
        isListening = false;
    }

    public void Dispose() { SensorService.StopListening(); }
}