@page "/monitoreo"
@page "/monitoreo/{SensorId:int}"
@using MonitoreoMultifuente3.Models
@using MonitoreoMultifuente3.Data
@using MonitoreoMultifuente3.DTOs
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject SensorDataService SensorService
@implements IDisposable

<PageTitle>
    @(SensorId == 0 ? "Monitoreo General" : $"Monitoreo: {nombreSensorActual}")
</PageTitle>

<div class="container-fluid">

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                📡 Configuración @(SensorId > 0 ? $"- {nombreSensorActual}" : "")
            </h5>
        </div>
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label class="form-label fw-bold">1. Ubicación / Escenario:</label>
                    <select class="form-select" @onchange="OnEscenarioChanged">
                        <option value="0">-- Seleccione Ubicación --</option>
                        @foreach (var esc in escenariosDisponibles)
                        {
                            <option value="@esc.escenario_id">@esc.descripcion (@esc.Ubicacion?.nombre)</option>
                        }
                    </select>
                    @if (selectedEscenarioId > 0)
                    {
                        <small class="text-success">✔ Guardando en: <b>@nombreEscenarioActual</b></small>
                    }
                </div>

                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Conexión Arduino:</label>
                    <div class="input-group">
                        <select @bind="selectedPort" class="form-select" disabled="@isListening">
                            <option value="">Seleccionar Puerto</option>
                            @foreach (var port in availablePorts)
                            {
                                <option value="@port">@port</option>
                            }
                        </select>
                        @if (!isListening)
                        {
                            <button class="btn btn-primary" @onclick="StartListening"
                                    disabled="@(string.IsNullOrEmpty(selectedPort) || selectedEscenarioId == 0)">
                                ▶ Conectar
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-danger" @onclick="StopListening">
                                ⏹ Desconectar
                            </button>
                        }
                    </div>
                </div>

                <div class="col-md-2 text-center">
                    @if (isListening)
                    {
                        <span class="badge bg-success p-2">● En Vivo</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary p-2">● Pausado</span>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-2 mb-0 p-2">@errorMessage</div>
            }
        </div>
    </div>

    <div class="row">

        <div class="col-lg-4 mb-4">
            <div class="card shadow h-100 border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between">
                    <h5 class="mb-0">⚡ Tiempo Real</h5>
                    <small>@ultimoUpdate.ToString("HH:mm:ss")</small>
                </div>
                <div class="card-body">
                    @if (latestData != null)
                    {
                        <ul class="list-group list-group-flush">

                            @* --- SOLO SE MUESTRA SI ES SENSOR DE pH O GENERAL --- *@
                            @if (verPH)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h1 class="mb-0 text-primary display-6">pH</h1>
                                        <small class="text-muted">Potencial Hidrógeno</small>
                                    </div>
                                    <div class="text-end">
                                        <h2 class="mb-0">@latestData.PH.ToString("F2")</h2>
                                        <span class="badge bg-@GetColorStatus(latestData.PhStatus)">@latestData.PhStatus</span>
                                    </div>
                                </li>
                            }

                            @* --- SOLO SE MUESTRA SI ES SENSOR DE TURBIDEZ O GENERAL --- *@
                            @if (verTurbidez)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h1 class="mb-0 text-info display-6">NTU</h1>
                                        <small class="text-muted">Turbidez</small>
                                    </div>
                                    <div class="text-end">
                                        <h2 class="mb-0">@latestData.TurbidezNTU.ToString("F2")</h2>
                                        <span class="badge bg-@GetColorStatus(latestData.TurbidezStatus)">@latestData.TurbidezStatus</span>
                                    </div>
                                </li>
                            }

                            @* --- TEMPERATURA Y CONDUCTIVIDAD (Siempre visibles como referencia) --- *@
                            <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                <span class="h6 mb-0">Temp:</span>
                                <span class="h5 mb-0">@latestData.TemperaturaC.ToString("F1") °C</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                <span class="h6 mb-0">Cond:</span>
                                <span class="h5 mb-0">@latestData.ConductividadUsScm.ToString("F0") µS</span>
                            </li>
                        </ul>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <p>Esperando datos...</p>
                            <small>Conecte el dispositivo para ver valores.</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">📅 Historial (@(SensorId == 0 ? "Todo" : nombreSensorActual))</h5>
                    <button class="btn btn-sm btn-light text-dark" @onclick="CargarHistorial">🔄 Actualizar Tabla</button>
                </div>
                <div class="card-body p-0 table-responsive" style="max-height: 500px; overflow-y: auto;">
                    @if (historialMediciones.Any())
                    {
                        <table class="table table-striped table-hover mb-0 table-sm align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Hora</th>
                                    <th>Parámetro</th>
                                    <th>Valor</th>
                                    <th>Estado</th>
                                    <th>CV (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in historialMediciones)
                                {
                                    <tr>
                                        <td>@item.fecha_hora.ToLocalTime().ToString("HH:mm:ss")</td>
                                        <td class="fw-bold text-primary">@item.Parametro?.nombre_parametro</td>

                                        <td class="fs-5">@item.valor_analogico.ToString("F2")</td>

                                        <td>
                                            @{
                                                var estadoEnum = (MonitoreoMultifuente3.Enums.StatusMedicion)item.status;
                                            }
                                            <span class="badge bg-@GetColorStatus(estadoEnum.ToString())">@estadoEnum</span>
                                        </td>

                                        <td>@((item.valor_cv_decimal ?? 0).ToString("F2"))%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="p-5 text-center text-muted">
                            @if (selectedEscenarioId == 0)
                            {
                                <span>Seleccione un escenario arriba para cargar datos.</span>
                            }
                            else
                            {
                                <span>No hay registros guardados con este filtro.</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

    </div>
</div>

@code {
    [Parameter] public int SensorId { get; set; } = 0;

    // --- Variables Visuales (Filtros) ---
    private string nombreSensorActual = "General";
    private bool verPH = true;
    private bool verTurbidez = true;

    // --- Variables Datos ---
    private List<Escenario> escenariosDisponibles = new();
    private List<Medicion> historialMediciones = new();
    private LecturaArduinoDto? latestData;
    private DateTime ultimoUpdate = DateTime.Now;
    private string nombreEscenarioActual = "Ninguno";

    // --- Variables Conexión ---
    private string[] availablePorts = Array.Empty<string>();
    private string selectedPort = "";
    private int selectedEscenarioId = 0;
    private bool isListening = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        escenariosDisponibles = await context.Escenarios
            .Include(e => e.Ubicacion)
            .OrderByDescending(e => e.created_at)
            .ToListAsync();

        if (!isListening)
        {
            availablePorts = SensorService.GetAvailablePorts();
            if (availablePorts.Length > 0) selectedPort = availablePorts[0];
        }
        SensorService.OnDataReceived += HandleDataReceived;
    }

    // --- LÓGICA INTELIGENTE PARA DETECTAR EL SENSOR ---
    protected override async Task OnParametersSetAsync()
    {
        if (SensorId > 0)
        {
            using var context = DbFactory.CreateDbContext();
            var sensor = await context.Sensores
                                      .Include(s => s.Parametros)
                                      .FirstOrDefaultAsync(s => s.sensor_id == SensorId);

            if (sensor != null)
            {
                nombreSensorActual = sensor.nombre_sensor ?? "Sensor Desconocido";
                var nombreLower = nombreSensorActual.ToLower();

                // Lógica: Si el nombre dice "ph", mostramos solo pH. Si dice "turbidez", solo turbidez.
                bool esSensorSoloPH = nombreLower.Contains("ph") && !nombreLower.Contains("turbidez") && !nombreLower.Contains("multi");
                bool esSensorSoloTurb = nombreLower.Contains("turbidez") && !nombreLower.Contains("ph") && !nombreLower.Contains("multi");

                if (esSensorSoloPH)
                {
                    verPH = true;
                    verTurbidez = false;
                }
                else if (esSensorSoloTurb)
                {
                    verPH = false;
                    verTurbidez = true;
                }
                else
                {
                    // Si es genérico, miramos los parámetros de la BD
                    verPH = sensor.Parametros.Any(p => p.nombre_parametro != null && p.nombre_parametro.ToLower().Contains("ph"));
                    verTurbidez = sensor.Parametros.Any(p => p.nombre_parametro != null && p.nombre_parametro.ToLower().Contains("turbidez"));
                }
            }
        }
        else
        {
            // Vista General (Sin ID) -> Mostramos Todo
            nombreSensorActual = "Vista General";
            verPH = true;
            verTurbidez = true;
        }

        // Si ya hay escenario seleccionado, recargamos la tabla con los nuevos filtros
        if (selectedEscenarioId > 0) await CargarHistorial();
    }

    private async Task OnEscenarioChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedEscenarioId = id;
            var escenario = escenariosDisponibles.FirstOrDefault(x => x.escenario_id == id);
            nombreEscenarioActual = escenario?.descripcion ?? "Desconocido";

            SensorService.SetCurrentEscenario(selectedEscenarioId);
            await CargarHistorial();
        }
    }

    // --- FILTRADO DE TABLA ESTRICTO ---
    private async Task CargarHistorial()
    {
        if (selectedEscenarioId == 0) return;

        using var context = DbFactory.CreateDbContext();

        // 1. Filtro base: Escenario seleccionado
        var query = context.Mediciones
            .Include(m => m.Parametro)
            .Where(m => m.escenario_id == selectedEscenarioId);

        // 2. Filtro por ID de Sensor (si estamos en una vista específica)
        if (SensorId > 0)
        {
            query = query.Where(m => m.sensor_id == SensorId);

            // 3. FILTRO EXTRA DE LIMPIEZA:
            // Si la vista es SOLO de pH, excluimos cualquier registro que diga "Turbidez"
            // Esto limpia la tabla si tus datos históricos están mezclados.
            if (verPH && !verTurbidez)
            {
                query = query.Where(m => m.Parametro.nombre_parametro.Contains("pH"));
            }
            else if (!verPH && verTurbidez)
            {
                query = query.Where(m => m.Parametro.nombre_parametro.Contains("Turbidez"));
            }
        }

        historialMediciones = await query
            .OrderByDescending(m => m.fecha_hora)
            .Take(50)
            .ToListAsync();

        await InvokeAsync(StateHasChanged);
    }

    private void StartListening()
    {
        if (selectedEscenarioId == 0)
        {
            errorMessage = "⚠ Seleccione un escenario primero.";
            return;
        }
        errorMessage = null;
        SensorService.SetCurrentEscenario(selectedEscenarioId);

        if (SensorService.StartListening(selectedPort)) isListening = true;
        else errorMessage = $"Error al abrir {selectedPort}";
    }

    private void StopListening()
    {
        isListening = false;
        SensorService.StopListening();
        latestData = null;
        StateHasChanged();
    }

    private void HandleDataReceived(LecturaArduinoDto lectura)
    {
        latestData = lectura;
        ultimoUpdate = DateTime.Now;
        // Retardo pequeño para dar tiempo a la BD a guardar antes de leer
        _ = InvokeAsync(async () =>
        {
            await Task.Delay(200);
            await CargarHistorial();
        });
        InvokeAsync(StateHasChanged);
    }

    private string GetColorStatus(string? status)
    {
        if (string.IsNullOrEmpty(status)) return "secondary";
        return status.ToLower() switch
        {
            "ideal" => "success",
            "apta" => "warning",
            "no apta" => "danger",
            _ => "secondary"
        };
    }

    public void Dispose()
    {
        SensorService.OnDataReceived -= HandleDataReceived;
        if (isListening) SensorService.StopListening();
    }
}