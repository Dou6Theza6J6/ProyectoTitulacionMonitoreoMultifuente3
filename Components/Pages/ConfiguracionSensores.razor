@page "/configuracion-sensores"
@* ESTA LÍNEA ES LA CLAVE DE LA SEGURIDAD *@
@attribute [Authorize(Roles = "Administrador")]

@using Microsoft.EntityFrameworkCore
@using MonitoreoMultifuente3.Services
@inject ApplicationDbContext DbContext
@inject SensorStatusService StatusService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Configuración de Sensores</PageTitle>

<h3>Configuración de Sensores</h3>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">Registrar Nuevo Sensor</div>
            <div class="card-body">
                <EditForm Model="@nuevoSensor" OnValidSubmit="GuardarSensor">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-2" />

                    <div class="mb-3">
                        <label class="form-label">Nombre del Sensor</label>
                        <InputText class="form-control" @bind-Value="nuevoSensor.nombre_sensor" placeholder="Ej: Sensor pH Principal" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Modelo del Sensor</label>
                        <InputText class="form-control" @bind-Value="nuevoSensor.modelo" placeholder="Ej: Atlas Scientific EZO-pH" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Sensor</label>
                        <InputSelect class="form-select" @bind-Value="nuevoSensor.tipo">
                            <option value="0">Analógico</option>
                            <option value="1">Digital</option>
                        </InputSelect>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio (Opcional)</label>
                        <InputNumber class="form-control" @bind-Value="nuevoSensor.precio" />
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Sensor</button>
                </EditForm>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">Registrar Nuevo Parámetro</div>
            <div class="card-body">
                <EditForm Model="@nuevoParametro" OnValidSubmit="GuardarParametro">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-2" />

                    <div class="mb-3">
                        <label class="form-label">Sensor Asociado</label>
                        <InputSelect class="form-select" @bind-Value="nuevoParametro.sensor_id">
                            <option value="0">Seleccione un sensor...</option>
                      @foreach (var sensor in sensores)
                            {
                                <option value="@sensor.sensor_id">@sensor.nombre_sensor (@sensor.sensor_id)</option>
                            }  
                        </InputSelect>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre del Parámetro (Exacto como en el JSON)</label>
                        <InputText class="form-control" @bind-Value="nuevoParametro.nombre_parametro" placeholder="Ej: ph, turbidez, temperatura" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unidad de Medida</label>
                        <InputText class="form-control" @bind-Value="nuevoParametro.unidad_medida" placeholder="Ej: pH, NTU, °C, µS/cm" />
                    </div>
                    <button type="submit" class="btn btn-info">Guardar Parámetro</button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

<hr class="my-4" />

<h4>Sensores Registrados</h4>
@if (sensores.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre Sensor</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Creado</th>
                    <th>Actualizado</th>
                    <th>Parámetros</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var sensor in sensores)
                {
                    <tr>
                        <td>@sensor.sensor_id</td>
                        <td>@sensor.nombre_sensor</td>
                        <td>@(sensor.tipo == 0 ? "Analógico" : "Digital")</td>
                        <td>
                            @{
                                var estado = StatusService.GetSensorState(sensor.sensor_id);
                                <span class="badge @GetStatusClass(estado)">@estado</span>
                            }
                        </td>
                        <td>@sensor.created_at.ToLocalTime().ToString("g")</td>
                        <td>@sensor.updated_at.ToLocalTime().ToString("g")</td>

                        <td>
                            @if (sensor.Parametros != null && sensor.Parametros.Any())
                            {
                                @string.Join(", ", sensor.Parametros.Select(p => p.nombre_parametro))
                            }
                            else
                            {
                                <span class="text-muted">Sin parámetros</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-danger btn-sm" @onclick="() => EliminarSensor(sensor.sensor_id)">Eliminar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p>No hay sensores registrados. Añade uno usando el formulario de arriba.</p>
}


@code {
    private List<Sensor> sensores = new();
    private Sensor nuevoSensor = new();
    private Parametro nuevoParametro = new();
    private Timer? _timer; // Timer para refrescar el estado

    protected override async Task OnInitializedAsync()
    {
        await CargarSensores();
        // Inicia un timer que refrescará la tabla cada 5 segundos para actualizar el estado
        _timer = new Timer(async _ => await InvokeAsync(StateHasChanged), null, TimeSpan.Zero, TimeSpan.FromSeconds(5));
    }

    private async Task CargarSensores()
    {
        sensores = await DbContext.Sensores
            .Include(s => s.Parametros) // Incluye los parámetros para mostrarlos
            .OrderBy(s => s.sensor_id)
            .ToListAsync();
    }

    private async Task GuardarSensor()
    {
        // Validaciones básicas (puedes añadir más)
        nuevoSensor.created_at = DateTime.UtcNow; // Agregar esto
        nuevoSensor.updated_at = DateTime.UtcNow; // Agregar esto
        if (string.IsNullOrWhiteSpace(nuevoSensor.nombre_sensor) || string.IsNullOrWhiteSpace(nuevoSensor.modelo))
        {
            // Podrías mostrar un mensaje de error al usuario
            return;
        }
        DbContext.Sensores.Add(nuevoSensor);
        await DbContext.SaveChangesAsync();
        nuevoSensor = new(); // Limpia el formulario
        await CargarSensores(); // Recarga la lista
    }

    private async Task GuardarParametro()
    {
        // Validaciones básicas
        if (nuevoParametro.sensor_id == 0 || string.IsNullOrWhiteSpace(nuevoParametro.nombre_parametro) || string.IsNullOrWhiteSpace(nuevoParametro.unidad_medida))
        {
            return;
        }
        DbContext.Parametros.Add(nuevoParametro);
        await DbContext.SaveChangesAsync();
        nuevoParametro = new(); // Limpia el formulario
        await CargarSensores(); // Recarga la lista (para que se actualice la columna de parámetros)
    }

    // --- NUEVO MÉTODO PARA ELIMINAR SENSOR ---
    private async Task EliminarSensor(int sensorId)
    {
        // Pide confirmación al usuario
        var confirmado = await JSRuntime.InvokeAsync<bool>("confirm", "¿Estás seguro de que deseas eliminar este sensor? Esta acción no se puede deshacer.");
        if (confirmado)
        {
            var sensorAEliminar = await DbContext.Sensores.FindAsync(sensorId);
            if (sensorAEliminar != null)
            {
                DbContext.Sensores.Remove(sensorAEliminar);
                await DbContext.SaveChangesAsync();
                await CargarSensores(); // Recarga la lista para que desaparezca de la tabla
            }
        }
    }

    // El método GetStatusClass ahora recibe el enum SensorState
    private string GetStatusClass(SensorState estado)
    {
        return estado switch
        {
            SensorState.Activo => "bg-success",
            SensorState.Inactivo => "bg-secondary",
            SensorState.Error => "bg-danger",
            _ => "bg-light text-dark"
        };
    }

    // Implementa IDisposable para detener el timer cuando sales de la página
    public void Dispose()
    {
        _timer?.Dispose();
    }
}